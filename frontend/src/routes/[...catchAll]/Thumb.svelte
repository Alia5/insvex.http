<script lang="ts">
import { browser } from '$app/environment';
import { getIcon } from 'material-file-icons';
import { onMount } from 'svelte';
import { mimeAdditions } from './mime-patches';
import { lookup } from 'mime-types';

export let file: string;
export let prefixPath: string;
export let isDir = false;

const icon = getIcon(file);

let thisImgEl: HTMLImageElement | undefined;
let thumbLoaded = !browser;
onMount(() => {
    if (thisImgEl?.complete && thisImgEl?.naturalHeight > 1) {
        thumbLoaded = true;
    }
});

let fileIconColor = '#000000af';

let maybeIconColor = icon.svg.match(/fill="([^"]+)"/)?.[1];
if (maybeIconColor === 'none') {
    maybeIconColor = icon.svg.match(/stroke="([^"]+)"/)?.[1];
}
if (maybeIconColor && maybeIconColor !== 'none') {
    fileIconColor = maybeIconColor;
}

const fullImageThumbs = import.meta.env.INSVEX_BUILDCONFIG_SPA_FULL_IMAGE_THUMBS === 'true';
let shouldShowThumbImg = true;
/* eslint-disable prettier/prettier */
if (
    import.meta.env.INSVEX_BUILDCONFIG_SPA === 'true'
    && import.meta.env.INSVEX_BUILDCONFIG_DIRECTORY_INDEX_NAME
) {
    // NginX directory index mode
    shouldShowThumbImg = false;
}
/* eslint-enable prettier/prettier */

$: mime = mimeAdditions(file) || lookup(file.split('.')?.pop() || '');
$: isImage = mime && mime?.includes('image');
</script>

<div class="thumb-container">
    <picture>
        {#if shouldShowThumbImg || (fullImageThumbs && isImage)}
            <img
                id="{file}"
                loading="lazy"
                src="{fullImageThumbs ? `/${file}` : `${prefixPath}/?thumb=${file}`}"
                alt=""
                class="thumb-img"
                style="{`opacity: ${thumbLoaded ? 1 : 0};`}"
                on:load="{() => {
                    thumbLoaded = true;
                }}"
                bind:this="{thisImgEl}" />
        {/if}
        <div
            class="default-thumb-container"
            style="{browser ? (thumbLoaded ? 'opacity: 0;' : 'opacity: 1;') : 'opacity: 1;'}">
            {#if isDir}
                <div class="dir-thumb"></div>
            {:else}
                <div class="file-thumb">
                    <div class="{`file-icon-${icon.name}`}">
                        <!-- eslint-disable-next-line svelte/no-at-html-tags -->
                        {@html icon.svg}
                    </div>
                    <span style="{`--color: ${fileIconColor};`}"
                        >{(file.split('.')?.pop() || '').toUpperCase()}</span>
                </div>
            {/if}
        </div>
    </picture>
</div>

<style lang="postcss">
.thumb-container {
    width: 100%;
    height: 100%;
    display: grid;
    place-items: center;
    position: absolute;
    isolation: isolate;
}

picture {
    position: relative;
    display: grid;
    place-items: center;
    isolation: isolate;
    width: 100%;
    height: 100%;
}

.default-thumb-container {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    translate: 0 -1em;
    z-index: 1;
}

.dir-thumb {
    --width: 5.5em;
    --height: 4em;
    --color: #cfcfcf;
    --border-radius: 0.5em;
    --shadow: 0.2em 0.2em 0.2em var(--shadowColor);
    position: relative;
    width: var(--width);
    height: var(--height);
    &::before {
        content: '';
        position: absolute;
        width: calc(var(--width) * 0.45);
        height: var(--height);
        left: 0;
        top: calc(var(--border-radius) * -1.2);
        background: var(--color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }
    &::after {
        content: '';
        position: absolute;
        width: var(--width);
        height: var(--height);
        background: var(--color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }
}

.file-thumb {
    --color: #cfcfcf;
    --shadow: 0.2em 0.2em 0.2em var(--shadowColor);
    width: 5.5em;
    height: 7em;
    position: relative;
    display: grid;
    place-items: center;
    grid-template-rows: auto min-content;
    border-radius: 0.5em 0.5em 0.5em 0.5em;
    overflow: hidden;
    filter: drop-shadow(var(--shadow));

    background-image: linear-gradient(to bottom left, transparent 50%, white 50%),
        linear-gradient(var(--color), var(--color)), linear-gradient(var(--color), var(--color));
    background-size:
        25px 25px,
        100% 100%,
        100% 100%;
    background-position:
        100% 0%,
        -25px 0%,
        100% 25px;
    background-repeat: no-repeat;

    & > div {
        padding: 1.5em 1.5em 0 1.5em;
    }

    & > span {
        color: var(--textColorLight);
        background: var(--color);
        width: 100%;
        padding: 0.25rem;
        text-align: center;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        transition-property: none;
    }
}

.thumb-img {
    color: transparent;
    object-fit: auto;
    z-index: 2;
    width: 100%;
    height: 100%;
    text-indent: -100vh;
}
</style>
